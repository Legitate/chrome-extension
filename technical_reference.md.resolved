# Technical Reference: NotebookLM Reverse Engineering

This document details the critical findings and technical quirks discovered while reverse-engineering the NotebookLM API. It serves as a guide for future maintenance or debugging.

## 1. Dynamic Session Parameters (`bl`)

**Issue**: The backend rejects requests (Error 143/145 or silent failure) if the `bl` parameter (Build Label/Version Token) in the RPC call does not match the server's expected version.

**Solution**:
- The client must **dynamically scrape** the `bl` parameter from the NotebookLM homepage on initialization.
- **Regex**: `r'"(boq_[^"]+)"'`
- **Preference**: Prefer `boq_labs-tailwind` versions over generic `boq_identity`.
- **Implementation**: See `NotebookLMClient._fetch_params`.

## 2. Robust JSON Parsing (`batchexecute`)

**Issue**: The Google RPC response (`batchexecute`) uses a custom format: `)]}'\n` followed by length-prefixed chunks (e.g., `123\n[[...]]`).
- The length prefix is in **bytes**. Parsing by counting characters fails when the response contains multi-byte Unicode characters (common in YouTube titles), leading to offset errors.

**Solution**:
- **Do not use byte slicing**. It is brittle.
- **Line-based Heuristic**: Decode the entire response to UTF-8 (ignoring errors). Split by `\n`. Iterate through lines and try `json.loads()` on any line starting with `[[`.
- **Implementation**: See `NotebookLMClient._parse_envelope`.

## 3. Nested Source IDs (`izAoDd`)

**Issue**: When adding a source via the `izAoDd` RPC, the response contains the new Source ID, but it is often deeply nested inside a **stringified JSON** object within the main JSON response.
- Example: `[..., "[[[\"SOURCE_ID\"], ...]]", ...]`

**Solution**:
- Use a **recursive search** that also attempts to unwrap/parse any string value that looks like a JSON array/object (`startsWith('[')`).
- **Implementation**: See `NotebookLMClient._find_uuid`.

## 4. Extension UX Constraints

**Issue**: Modern Chrome extensions (Manifest V3) prevent opening popups programmatically without user interaction.

**Solution**:
- **Context-Aware Action**: The extension icon is disabled by default.
- **Background Listener**: [content.js](file:///Users/vigneshdhanraj/Desktop/Altrosyn/notebook/chrome_extension/content.js) detects YouTube URLs and signals [background.js](file:///Users/vigneshdhanraj/Desktop/Altrosyn/notebook/chrome_extension/background.js) to `chrome.action.enable()`.
- **User Flow**: The user sees the icon light up on YouTube -> Clicks it -> Popup opens.
